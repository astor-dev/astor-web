---
id: "620491424848154624"
author: "Astor"
title: "스타트업 결제 도메인 구축기 - 결제·환불의 동시성 제어 및 멱등성 전략"
pinned: true
draft: true
tags:
  - 결제
  - 환불
  - 토스페이먼츠
ogImage: "https://d2r0pavv0lsiqc.cloudfront.net/posts/images/ad655d22-f229-484e-b348-3e3188b1d8bd.webp"
seriesId: ""
createdAt: "2025-09-09 13:45:11"
updatedAt: "2025-09-09 14:31:23"
---

서비스에서 수익 창출을 이루려면 결국 결제 도메인을 구축해야합니다. 필자가 극초기 스타트업에서 결제 도메인을 처음부터 구축하고, 25년 9월까지 6억 매출을 처리한 시스템을 개발한 경험을 토대로 결제 도메인에 대해 분석 및 발생할 수 있는 문제상황과 처리 전략에 대해 소개하겠습니다.

결제 도메인에 대한 설명이나 PG사 연동 방법 같은 부분은 소개하지 않겠습니다.

***

결제와 같이 실제 통화가 오가는 엄밀한 도메인은, 무조건 **AT-LEAST-ONCE를 보장**해야 합니다. 따라서 중복 발생 케이스에 대해선 최대한 비관적으로 접근해 재시도나 경합 상황에 대해 엔지니어링 해야 합니다.&#x20;

결국 경합되는 자원에 대한 동시성 제어와 중복 처리 등을 안전히 처리할 수 있는 멱등성 보장이 굉장히 중요해집니다. 하나씩 알아보겠습니다.

## 동시성 제어

동시성 제어에 대해서만 엄밀히 이야기하기 위해 우선 **멱등성이 보장된 상황을 가정**하겠습니다. 즉 동일 요청이 여러번 들어오거나, 처리 중 실패하는 등의 문제 상황은 차치하겠습니다.

결국 동시성 제어의 핵심은 **경합되는 자원에 대한 락처리** 입니다. 결제 도메인의 경우 유관 자원이 되게 많은데, 거래, 쿠폰, 결제 원천(예약이나 구독 등), 상품 등의 정보가 순간순간 얽혀 읽고 써져야합니다.

서비스 로직에서 주로 경합되는 자원은 **상품의 재고**, **거래 객체**, **결제 원천의 상태**, **환불 (요청) 객체** 정도 될 것 같습니다. 결제의 흐름을 토대로 이 자원들의 동시성 문제를 어떻게 해결하는 지 살펴 보겠습니다.

### 거래 생성에 대한 제어

유저가 상품을 구매하면 결제 원천과 거래 객체를 생성합니다. 생성 부분이라 경합되는 자원은 없습니다. 다만, 이때 **상품의 재고**라는 관심사가 존재하는데, 재고가 존재하는 상품을 팔기 위해서는 결제 시 재고에 대한 **유효성 검사**가 들어가야 합니다.

이 유효성 검사를 **거래 생성 시**에도 할 수 있고, **승인(실제로 돈이 빠져나가는 시점) 시**에도 할 수 있는데 코레일톡 처럼 **실제 결제 처리 전 특정 시간만큼 자원을 선점**해주는 경우 **결제 생성 시점에 재고에 대한 검증 및 차감 처리**를 해야합니다.

처리 방식은 간단한데, 결제 생성 시 상품 객체를 읽으며 **낙관적 쓰기 락**을 걸면 됩니다. 상품 객체의 경우 대부분 접근이 잦기에 비관적 쓰기 락을 쓰기엔 부하가 큽니다. 낙관적 쓰기 락을 쓴 경우 (상품 조회 -> 거래 생성 -> 상품 재고 차감) 트랜잭션이 경합되어 로직 중 다른 트랜잭션이 상품에 대해 커밋한 경우 트랜잭션이 실패하고 롤백되게 됩니다. 다만 중요한 건, 이렇게 롤백된 케이스는 비즈니스 상황 상의 에러는 아니기에 처음부터 **재처리**를 해주셔야 합니다.

### 결제 미처리 시에 대한 제어

거래가 생성 된 이후 PG 통신 부분에서 거래가 이루어지지 않으면 해당 거래는 불발처리 되어야 합니다. 이때 보통 특정 시간이 지난 거래를 불발 시킬 텐데, **불발 로직 처리 중에 유저가 결제를 처리해버리면 동시성 문제**가 발생합니다.

**불발 처리할 거래를 읽는 시점에 비관적 쓰기 락**을 사용합니다. 불발될 거래에 대해 결제 승인 등의 로직에서 접근하는 것을 원천적으로 차단합니다. 다만 이 때 반드시 주의하셔야 할 점은, 비관적 락을 쓰기 때문에 **여러 테이블에 동시 접근하면 데드락**이 생길 수 있습니다. 가령 거래와 예약 테이블을 동시에 비관적 쓰기 락으로 읽으면 거래 락 취득 - 예약 락 취득 사이에 다른 어딘가에서 예약 락을 얻고 거래 락을 얻으려 하면 데드락이 발생합니다.

솔루션은, 모든 **거래에만 쓰기 락으로 접근**을 합니다. 그 후 유관 도메인의 상태 전파를 **이벤트로 처리**하고, 개별 컨슈머 측에서 핸들링합니다.